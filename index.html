<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Can You Retire? - Retirement Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/plotly.js@2.27.0/dist/plotly.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --navy: #0a1128;
            --navy-light: #1e2749;
            --accent: #ff6b35;
            --accent-light: #ff8c61;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #d63031;
            --text: #2d3436;
            --text-light: #636e72;
            --bg: #f8f9fa;
            --card: #ffffff;
            --border: #e9ecef;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            color: white;
        }

        h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .subtitle {
            font-size: 1.25rem;
            opacity: 0.95;
            font-weight: 400;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            animation: slideUp 0.6s ease-out;
            animation-fill-mode: backwards;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card:nth-child(1) { animation-delay: 0.1s; }
        .card:nth-child(2) { animation-delay: 0.2s; }

        .card-header {
            font-family: 'Crimson Pro', serif;
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--navy);
            border-bottom: 3px solid var(--accent);
            padding-bottom: 0.75rem;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--navy);
            font-size: 0.95rem;
        }

        .label-hint {
            font-weight: 400;
            color: var(--text-light);
            font-size: 0.85rem;
            margin-left: 0.5rem;
        }

        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.3s ease;
            background: white;
        }

        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .input-prefix {
            position: relative;
        }

        .input-prefix::before {
            content: '$';
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-weight: 600;
        }

        .input-prefix input {
            padding-left: 2rem;
        }

        .input-suffix {
            position: relative;
        }

        .input-suffix::after {
            content: '%';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-weight: 600;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .btn {
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'DM Sans', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: white;
            border-color: var(--accent);
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'Crimson Pro', serif;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.85;
        }

        #chart {
            width: 100%;
            height: 600px;
            border-radius: 12px;
            overflow: hidden;
        }

        .income-expense-manager {
            margin-top: 2rem;
        }

        .stream-item {
            background: var(--bg);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--accent);
        }

        .stream-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .stream-name {
            font-weight: 600;
            color: var(--navy);
        }

        .btn-remove {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .stream-details {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .add-stream {
            width: 100%;
            margin-top: 1rem;
        }

        .toggle-group {
            display: flex;
            gap: 0.5rem;
            background: var(--bg);
            padding: 0.25rem;
            border-radius: 8px;
        }

        .toggle-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .toggle-btn.active {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tooltip-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 0.75rem;
            cursor: help;
            margin-left: 0.25rem;
        }

        .advanced-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px dashed var(--border);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .scenario-presets {
            display: none;
        }

        .preset-btn {
            display: none;
        }

        .help-text {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.25rem;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Can You Retire?</h1>
            <p class="subtitle" style="max-width: 900px; margin: 0 auto; line-height: 1.8;">
                This Monte Carlo retirement calculator runs <strong>10,000 simulations</strong> of your retirement using historical market data from 1871-2024. 
                It models stock, bond, and cash returns with realistic volatility and inflation, then shows the probability of different outcomes over your retirement years. 
                The chart visualizes your chances of running out of money (red), maintaining your savings (yellow/green), or growing your wealth (dark green), 
                alongside actuarial mortality probabilities (gray). <strong>Toggle "Show Mortality"</strong> to switch between viewing all outcomes including death (default), 
                or normalized financial outcomes that always sum to 100% (conditional on survival).
            </p>
        </header>

        <div class="main-grid">
            <!-- Left Sidebar - Inputs -->
            <div class="card">
                <div class="card-header">Your Scenario</div>

                <!-- Annual Return Assumption -->
                <div class="input-group">
                    <label>Expected Annual Return <span class="label-hint">(above inflation)</span></label>
                    <div class="input-suffix">
                        <input type="number" id="expectedReturn" value="5.0" min="0" max="10" step="0.1" onchange="calculate()">
                    </div>
                    <p class="help-text">Conservative: 3-4%, Moderate: 5-6%, Aggressive: 7-8%</p>
                </div>

                <!-- Basic Info -->
                <div class="input-group">
                    <label>Current Age</label>
                    <input type="number" id="currentAge" value="40" min="18" max="100" onchange="calculate()">
                </div>

                <div class="input-group">
                    <label>Retirement Age</label>
                    <input type="number" id="retirementAge" value="50" min="18" max="100" onchange="calculate()">
                </div>

                <div class="input-group">
                    <label>Life Expectancy <span class="label-hint">(years to plan for)</span></label>
                    <input type="number" id="lifeExpectancy" value="40" min="1" max="70" onchange="calculate()">
                </div>

                <div class="input-group">
                    <label>Sex</label>
                    <select id="sex" onchange="calculate()">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>

                <!-- Portfolio -->
                <div class="input-group">
                    <label>Current Savings</label>
                    <div class="input-prefix">
                        <input type="number" id="savings" value="1000000" min="0" step="10000" onchange="updateSavings()">
                    </div>
                </div>

                <div class="input-group">
                    <label>Annual Spending Needed <span class="label-hint">(in retirement)</span></label>
                    <div class="input-prefix">
                        <input type="number" id="spending" value="40000" min="0" step="1000" onchange="updateFromSpending()">
                    </div>
                </div>

                <div class="input-group">
                    <label>OR Withdrawal Rate <span class="label-hint">(% of savings)</span></label>
                    <div class="input-suffix">
                        <input type="number" id="withdrawalRateInput" value="4.0" min="0" max="20" step="0.1" onchange="updateFromWithdrawalRate()">
                    </div>
                </div>

                <!-- Asset Allocation -->
                <div class="input-group">
                    <label>Stocks %</label>
                    <div class="input-suffix">
                        <input type="number" id="stocks" value="60" min="0" max="100" onchange="updateAllocation()">
                    </div>
                </div>

                <div class="input-group">
                    <label>Bonds %</label>
                    <div class="input-suffix">
                        <input type="number" id="bonds" value="40" min="0" max="100" onchange="updateAllocation()">
                    </div>
                </div>

                <div class="input-group">
                    <label>Cash %</label>
                    <div class="input-suffix">
                        <input type="number" id="cash" value="0" min="0" max="100" onchange="updateAllocation()">
                    </div>
                </div>

                <!-- Advanced Options -->
                <div class="advanced-section">
                    <div class="input-group">
                        <label>Average Tax Rate</label>
                        <div class="input-suffix">
                            <input type="number" id="taxRate" value="15" min="0" max="50" step="0.5" onchange="calculate()">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Investment Fees</label>
                        <div class="input-suffix">
                            <input type="number" id="fees" value="0.3" min="0" max="5" step="0.1" onchange="calculate()">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Spending Flexibility <span class="label-hint">(% you can cut)</span></label>
                        <div class="input-suffix">
                            <input type="number" id="flexibility" value="20" min="0" max="50" step="5" onchange="calculate()">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Flexibility Threshold <span class="label-hint">(% of initial)</span></label>
                        <div class="input-suffix">
                            <input type="number" id="threshold" value="80" min="50" max="100" step="5" onchange="calculate()">
                        </div>
                    </div>
                </div>

                <!-- Income/Expense Manager -->
                <div class="income-expense-manager">
                    <div class="card-header" style="font-size: 1.25rem; margin-bottom: 1rem;">Additional Streams</div>
                    
                    <div class="toggle-group">
                        <button class="toggle-btn active" onclick="switchTab('income')">Income</button>
                        <button class="toggle-btn" onclick="switchTab('expenses')">Expenses</button>
                    </div>

                    <!-- Income Tab -->
                    <div id="income-tab" class="tab-content active" style="margin-top: 1rem;">
                        <div id="income-list"></div>
                        <button class="btn btn-secondary add-stream" onclick="addStream('income')">+ Add Income Stream</button>
                    </div>

                    <!-- Expenses Tab -->
                    <div id="expenses-tab" class="tab-content" style="margin-top: 1rem;">
                        <div id="expense-list"></div>
                        <button class="btn btn-secondary add-stream" onclick="addStream('expense')">+ Add Expense Stream</button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="btn-group">
                    <button class="btn btn-primary" style="flex: 1;" onclick="calculate()">Calculate</button>
                    <button class="btn btn-secondary" onclick="reset()">Reset</button>
                </div>
            </div>

            <!-- Right Side - Results -->
            <div>
                <!-- Results Summary -->
                <div class="card">
                    <div class="results-summary">
                        <div class="stat-card">
                            <div class="stat-value" id="successRate">--</div>
                            <div class="stat-label">Success Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="withdrawalRate">--</div>
                            <div class="stat-label">Withdrawal Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="medianBalance">--</div>
                            <div class="stat-label">Median Final Balance</div>
                        </div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Probability Analysis</span>
                        <label style="display: inline-flex; align-items: center; gap: 0.5rem; font-weight: normal; margin: 0; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" id="showMortality" checked onchange="toggleMortality()" style="cursor: pointer;">
                            <span>Show Mortality</span>
                        </label>
                    </div>
                    <div id="chart"></div>
                    <div class="help-text" style="margin-top: 1rem;">
                        This chart shows the probability of different portfolio outcomes over your retirement years. Green indicates wealth growth, yellow shows portfolio decline, red indicates running out of money, and gray shows probability of death. Toggle mortality to see financial outcomes normalized to 100%.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data structures
        let incomeStreams = [];
        let expenseStreams = [];
        let streamIdCounter = 0;

        // Format numbers with K for thousands, M for millions, B for billions
        function formatNumber(num) {
            if (num >= 1e9) {
                return '$' + (num / 1e9).toFixed(2) + 'B';
            } else if (num >= 1e6) {
                return '$' + (num / 1e6).toFixed(2) + 'M';
            } else if (num >= 1e3) {
                return '$' + (num / 1e3).toFixed(1) + 'K';
            } else {
                return '$' + num.toFixed(0);
            }
        }

        // Sync spending and withdrawal rate
        function updateFromSpending() {
            const spending = parseFloat(document.getElementById('spending').value);
            const savings = parseFloat(document.getElementById('savings').value);
            const rate = ((spending / savings) * 100).toFixed(2);
            document.getElementById('withdrawalRateInput').value = rate;
            calculate();
        }

        function updateFromWithdrawalRate() {
            const rate = parseFloat(document.getElementById('withdrawalRateInput').value);
            const savings = parseFloat(document.getElementById('savings').value);
            const spending = Math.round((rate / 100) * savings);
            document.getElementById('spending').value = spending;
            calculate();
        }

        // Update withdrawal rate when savings changes
        function updateSavings() {
            updateFromSpending();
        }

        // Shiller data (simplified historical returns - these are NOMINAL returns)
        const historicalReturns = {
            stocks: { mean: 0.10, stdDev: 0.18 },  // ~10% nominal, ~7% real
            bonds: { mean: 0.055, stdDev: 0.08 },  // ~5.5% nominal, ~2.5% real
            cash: { mean: 0.035, stdDev: 0.02 },   // ~3.5% nominal, ~0.5% real
            inflation: { mean: 0.031, stdDev: 0.05 }
        };

        // Mortality tables (SSA 2022 Period Life Table data)
        // Death probability = probability of dying within one year
        const mortalityTables = {
            male: [
                { age: 40, prob: 0.003353 }, { age: 41, prob: 0.003499 }, { age: 42, prob: 0.003642 },
                { age: 43, prob: 0.003811 }, { age: 44, prob: 0.003996 }, { age: 45, prob: 0.004175 },
                { age: 46, prob: 0.004388 }, { age: 47, prob: 0.004666 }, { age: 48, prob: 0.004973 },
                { age: 49, prob: 0.005305 }, { age: 50, prob: 0.005666 }, { age: 51, prob: 0.006069 },
                { age: 52, prob: 0.006539 }, { age: 53, prob: 0.007073 }, { age: 54, prob: 0.007675 },
                { age: 55, prob: 0.008348 }, { age: 56, prob: 0.009051 }, { age: 57, prob: 0.009822 },
                { age: 58, prob: 0.010669 }, { age: 59, prob: 0.011548 }, { age: 60, prob: 0.012458 },
                { age: 61, prob: 0.013403 }, { age: 62, prob: 0.014450 }, { age: 63, prob: 0.015571 },
                { age: 64, prob: 0.016737 }, { age: 65, prob: 0.017897 }, { age: 66, prob: 0.019017 },
                { age: 67, prob: 0.020213 }, { age: 68, prob: 0.021569 }, { age: 69, prob: 0.023088 },
                { age: 70, prob: 0.024828 }, { age: 71, prob: 0.026705 }, { age: 72, prob: 0.028761 },
                { age: 73, prob: 0.031116 }, { age: 74, prob: 0.033861 }, { age: 75, prob: 0.037088 },
                { age: 76, prob: 0.041126 }, { age: 77, prob: 0.045241 }, { age: 78, prob: 0.049793 },
                { age: 79, prob: 0.054768 }, { age: 80, prob: 0.060660 }, { age: 81, prob: 0.067027 },
                { age: 82, prob: 0.073999 }, { age: 83, prob: 0.081737 }, { age: 84, prob: 0.090458 },
                { age: 85, prob: 0.100525 }, { age: 86, prob: 0.111793 }, { age: 87, prob: 0.124494 },
                { age: 88, prob: 0.138398 }, { age: 89, prob: 0.153207 }, { age: 90, prob: 0.169704 },
                { age: 91, prob: 0.187963 }, { age: 92, prob: 0.208395 }, { age: 93, prob: 0.230808 },
                { age: 94, prob: 0.253914 }, { age: 95, prob: 0.277402 }, { age: 96, prob: 0.300882 },
                { age: 97, prob: 0.324326 }, { age: 98, prob: 0.347332 }, { age: 99, prob: 0.369430 },
                { age: 100, prob: 0.391927 }, { age: 101, prob: 0.414726 }, { age: 102, prob: 0.437722 },
                { age: 103, prob: 0.460800 }, { age: 104, prob: 0.483840 }, { age: 105, prob: 0.508032 },
                { age: 106, prob: 0.533434 }, { age: 107, prob: 0.560105 }, { age: 108, prob: 0.588111 },
                { age: 109, prob: 0.617516 }, { age: 110, prob: 0.648392 }, { age: 115, prob: 0.827531 },
                { age: 119, prob: 1.000000 }
            ],
            female: [
                { age: 40, prob: 0.001803 }, { age: 41, prob: 0.001905 }, { age: 42, prob: 0.002009 },
                { age: 43, prob: 0.002116 }, { age: 44, prob: 0.002223 }, { age: 45, prob: 0.002352 },
                { age: 46, prob: 0.002516 }, { age: 47, prob: 0.002712 }, { age: 48, prob: 0.002936 },
                { age: 49, prob: 0.003177 }, { age: 50, prob: 0.003407 }, { age: 51, prob: 0.003642 },
                { age: 52, prob: 0.003917 }, { age: 53, prob: 0.004238 }, { age: 54, prob: 0.004619 },
                { age: 55, prob: 0.005040 }, { age: 56, prob: 0.005493 }, { age: 57, prob: 0.005987 },
                { age: 58, prob: 0.006509 }, { age: 59, prob: 0.007067 }, { age: 60, prob: 0.007658 },
                { age: 61, prob: 0.008305 }, { age: 62, prob: 0.008991 }, { age: 63, prob: 0.009681 },
                { age: 64, prob: 0.010343 }, { age: 65, prob: 0.011018 }, { age: 66, prob: 0.011743 },
                { age: 67, prob: 0.012532 }, { age: 68, prob: 0.013512 }, { age: 69, prob: 0.014684 },
                { age: 70, prob: 0.016025 }, { age: 71, prob: 0.017468 }, { age: 72, prob: 0.019195 },
                { age: 73, prob: 0.021195 }, { age: 74, prob: 0.023452 }, { age: 75, prob: 0.025980 },
                { age: 76, prob: 0.029153 }, { age: 77, prob: 0.032394 }, { age: 78, prob: 0.035888 },
                { age: 79, prob: 0.039676 }, { age: 80, prob: 0.044156 }, { age: 81, prob: 0.049087 },
                { age: 82, prob: 0.054635 }, { age: 83, prob: 0.061066 }, { age: 84, prob: 0.068431 },
                { age: 85, prob: 0.076841 }, { age: 86, prob: 0.086205 }, { age: 87, prob: 0.096851 },
                { age: 88, prob: 0.109019 }, { age: 89, prob: 0.121867 }, { age: 90, prob: 0.135805 },
                { age: 91, prob: 0.151108 }, { age: 92, prob: 0.168020 }, { age: 93, prob: 0.186340 },
                { age: 94, prob: 0.206432 }, { age: 95, prob: 0.228086 }, { age: 96, prob: 0.250406 },
                { age: 97, prob: 0.273699 }, { age: 98, prob: 0.296984 }, { age: 99, prob: 0.319502 },
                { age: 100, prob: 0.342716 }, { age: 101, prob: 0.366532 }, { age: 102, prob: 0.390844 },
                { age: 103, prob: 0.415531 }, { age: 104, prob: 0.440463 }, { age: 105, prob: 0.466891 },
                { age: 106, prob: 0.494904 }, { age: 107, prob: 0.524599 }, { age: 108, prob: 0.556075 },
                { age: 109, prob: 0.589439 }, { age: 110, prob: 0.624805 }, { age: 115, prob: 0.827531 },
                { age: 119, prob: 1.000000 }
            ]
        };

        // Update allocation to sum to 100%
        function updateAllocation() {
            const stocks = parseFloat(document.getElementById('stocks').value) || 0;
            const bonds = parseFloat(document.getElementById('bonds').value) || 0;
            const cash = parseFloat(document.getElementById('cash').value) || 0;
            
            const total = stocks + bonds + cash;
            if (total !== 100 && total > 0) {
                document.getElementById('cash').value = Math.max(0, 100 - stocks - bonds);
            }
            calculate();
        }

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'income') {
                document.querySelector('.toggle-btn:first-child').classList.add('active');
                document.getElementById('income-tab').classList.add('active');
            } else {
                document.querySelector('.toggle-btn:last-child').classList.add('active');
                document.getElementById('expenses-tab').classList.add('active');
            }
        }

        // Add income/expense stream
        function addStream(type) {
            const name = prompt(`Enter ${type} name (e.g., Social Security, Pension):`);
            if (!name) return;

            const amount = parseFloat(prompt('Enter annual amount:'));
            if (!amount) return;

            const startAge = parseInt(prompt('Enter starting age:'));
            if (!startAge) return;

            const endAge = parseInt(prompt('Enter ending age (or leave blank for lifetime):'));

            const stream = {
                id: streamIdCounter++,
                name,
                amount,
                startAge,
                endAge: endAge || 999,
                type
            };

            if (type === 'income') {
                incomeStreams.push(stream);
            } else {
                expenseStreams.push(stream);
            }

            renderStreams();
            calculate();
        }

        // Remove stream
        function removeStream(type, id) {
            if (type === 'income') {
                incomeStreams = incomeStreams.filter(s => s.id !== id);
            } else {
                expenseStreams = expenseStreams.filter(s => s.id !== id);
            }
            renderStreams();
            calculate();
        }

        // Render streams
        function renderStreams() {
            const incomeList = document.getElementById('income-list');
            const expenseList = document.getElementById('expense-list');

            incomeList.innerHTML = incomeStreams.map(s => `
                <div class="stream-item">
                    <div class="stream-header">
                        <span class="stream-name">${s.name}</span>
                        <button class="btn-remove" onclick="removeStream('income', ${s.id})">Remove</button>
                    </div>
                    <div class="stream-details">
                        ${formatNumber(s.amount)}/yr from age ${s.startAge}${s.endAge < 999 ? ` to ${s.endAge}` : ''}
                    </div>
                </div>
            `).join('');

            expenseList.innerHTML = expenseStreams.map(s => `
                <div class="stream-item">
                    <div class="stream-header">
                        <span class="stream-name">${s.name}</span>
                        <button class="btn-remove" onclick="removeStream('expense', ${s.id})">Remove</button>
                    </div>
                    <div class="stream-details">
                        ${formatNumber(s.amount)}/yr from age ${s.startAge}${s.endAge < 999 ? ` to ${s.endAge}` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Monte Carlo simulation
        function runSimulation() {
            const currentAge = parseInt(document.getElementById('currentAge').value);
            const retirementAge = parseInt(document.getElementById('retirementAge').value);
            const lifeExpectancy = parseInt(document.getElementById('lifeExpectancy').value);
            const savings = parseFloat(document.getElementById('savings').value);
            const spending = parseFloat(document.getElementById('spending').value);
            const stocks = parseFloat(document.getElementById('stocks').value) / 100;
            const bonds = parseFloat(document.getElementById('bonds').value) / 100;
            const cash = parseFloat(document.getElementById('cash').value) / 100;
            const taxRate = parseFloat(document.getElementById('taxRate').value) / 100;
            const fees = parseFloat(document.getElementById('fees').value) / 100;
            const flexibility = parseFloat(document.getElementById('flexibility').value) / 100;
            const threshold = parseFloat(document.getElementById('threshold').value) / 100;
            const sex = document.getElementById('sex').value;
            const expectedReturn = parseFloat(document.getElementById('expectedReturn').value) / 100;

            const numSimulations = 10000;
            const years = lifeExpectancy;
            const results = [];

            // Calculate portfolio expected real return based on user input and asset allocation
            // We'll adjust the mean returns to match user's expected return
            const historicalPortfolioReal = stocks * (historicalReturns.stocks.mean - historicalReturns.inflation.mean) + 
                                           bonds * (historicalReturns.bonds.mean - historicalReturns.inflation.mean) + 
                                           cash * (historicalReturns.cash.mean - historicalReturns.inflation.mean);
            
            const returnAdjustment = expectedReturn - historicalPortfolioReal;

            for (let sim = 0; sim < numSimulations; sim++) {
                let balance = savings;
                let yearlyBalances = [balance];
                let initialBalance = balance;

                for (let year = 0; year < years; year++) {
                    const age = retirementAge + year;

                    // Calculate returns with user's expected return adjustment
                    const stockReturn = randomNormal(historicalReturns.stocks.mean + returnAdjustment, historicalReturns.stocks.stdDev);
                    const bondReturn = randomNormal(historicalReturns.bonds.mean + returnAdjustment * 0.5, historicalReturns.bonds.stdDev);
                    const cashReturn = randomNormal(historicalReturns.cash.mean + returnAdjustment * 0.2, historicalReturns.cash.stdDev);
                    const inflation = randomNormal(historicalReturns.inflation.mean, historicalReturns.inflation.stdDev);

                    const portfolioReturn = (stocks * stockReturn + bonds * bondReturn + cash * cashReturn) - fees;

                    // Calculate spending with flexibility
                    let currentSpending = spending * Math.pow(1 + inflation, year);
                    
                    // Apply flexibility if below threshold
                    if (balance < initialBalance * threshold * Math.pow(1 + inflation, year)) {
                        currentSpending *= (1 - flexibility);
                    }

                    // Add income streams
                    incomeStreams.forEach(stream => {
                        if (age >= stream.startAge && age <= stream.endAge) {
                            currentSpending -= stream.amount * Math.pow(1 + inflation, year - (stream.startAge - retirementAge));
                        }
                    });

                    // Add expense streams
                    expenseStreams.forEach(stream => {
                        if (age >= stream.startAge && age <= stream.endAge) {
                            currentSpending += stream.amount * Math.pow(1 + inflation, year - (stream.startAge - retirementAge));
                        }
                    });

                    // Apply taxes
                    const withdrawal = currentSpending / (1 - taxRate);

                    // Update balance
                    balance = balance * (1 + portfolioReturn) - withdrawal;

                    yearlyBalances.push(Math.max(0, balance));

                    if (balance <= 0) break;
                }

                results.push(yearlyBalances);
            }

            return results;
        }

        // Random normal distribution (Box-Muller transform)
        function randomNormal(mean, stdDev) {
            const u1 = Math.random();
            const u2 = Math.random();
            const z0 = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
            return mean + stdDev * z0;
        }

        // Get mortality probability
        function getMortalityProb(age, sex) {
            const table = mortalityTables[sex];
            
            // Find surrounding points
            let lower = table[0];
            let upper = table[table.length - 1];
            
            for (let i = 0; i < table.length - 1; i++) {
                if (age >= table[i].age && age < table[i + 1].age) {
                    lower = table[i];
                    upper = table[i + 1];
                    break;
                }
            }

            // Linear interpolation
            if (age <= lower.age) return lower.prob;
            if (age >= upper.age) return upper.prob;
            
            const ratio = (age - lower.age) / (upper.age - lower.age);
            return lower.prob + ratio * (upper.prob - lower.prob);
        }

        // Calculate and render chart
        function calculate() {
            const retirementAge = parseInt(document.getElementById('retirementAge').value);
            const lifeExpectancy = parseInt(document.getElementById('lifeExpectancy').value);
            const savings = parseFloat(document.getElementById('savings').value);
            const spending = parseFloat(document.getElementById('spending').value);
            const sex = document.getElementById('sex').value;

            // Run simulation
            const results = runSimulation();

            // Calculate percentiles for each year
            const years = lifeExpectancy;
            const percentiles = [];
            let cumulativeSurvival = 1.0; // Start with 100% alive

            for (let year = 0; year <= years; year++) {
                const yearBalances = [];
                
                // Get all balances for this year
                for (let sim = 0; sim < results.length; sim++) {
                    if (results[sim].length > year) {
                        yearBalances.push(results[sim][year]);
                    } else {
                        yearBalances.push(0); // Ran out of money
                    }
                }
                
                yearBalances.sort((a, b) => a - b);
                
                // Calculate ANNUAL probability of death at this age
                const annualDeathProb = getMortalityProb(retirementAge + year, sex);
                
                // Update cumulative survival probability
                cumulativeSurvival *= (1 - annualDeathProb);
                
                // Cumulative probability of being dead by this age
                const cumulativeDeathProb = 1 - cumulativeSurvival;
                
                // The probability of being alive at this age
                const aliveProb = cumulativeSurvival;
                
                // Among those alive, calculate financial outcome probabilities
                const totalSims = yearBalances.length;
                const numBroke = yearBalances.filter(b => b === 0).length;
                const numBelow1x = yearBalances.filter(b => b > 0 && b < savings).length;
                const num1xTo2x = yearBalances.filter(b => b >= savings && b < savings * 2).length;
                const num2xTo5x = yearBalances.filter(b => b >= savings * 2 && b < savings * 5).length;
                const num5xTo10x = yearBalances.filter(b => b >= savings * 5 && b < savings * 10).length;
                const numAbove10x = yearBalances.filter(b => b >= savings * 10).length;
                
                // These are the probabilities GIVEN that you're alive (conditional probabilities)
                const brokeGivenAlive = numBroke / totalSims;
                const below1xGivenAlive = numBelow1x / totalSims;
                const from1xTo2xGivenAlive = num1xTo2x / totalSims;
                const from2xTo5xGivenAlive = num2xTo5x / totalSims;
                const from5xTo10xGivenAlive = num5xTo10x / totalSims;
                const above10xGivenAlive = numAbove10x / totalSims;
                
                // Store both versions: 
                // - raw: includes mortality (financial outcomes scaled by aliveProb)
                // - normalized: conditional on being alive (always sums to 100%)
                percentiles.push({
                    year,
                    age: retirementAge + year,
                    p10: yearBalances[Math.floor(yearBalances.length * 0.1)],
                    p25: yearBalances[Math.floor(yearBalances.length * 0.25)],
                    p50: yearBalances[Math.floor(yearBalances.length * 0.5)],
                    p75: yearBalances[Math.floor(yearBalances.length * 0.75)],
                    p90: yearBalances[Math.floor(yearBalances.length * 0.9)],
                    // Raw probabilities (include mortality impact)
                    brokeRaw: brokeGivenAlive * aliveProb,
                    below1xRaw: below1xGivenAlive * aliveProb,
                    from1xTo2xRaw: from1xTo2xGivenAlive * aliveProb,
                    from2xTo5xRaw: from2xTo5xGivenAlive * aliveProb,
                    from5xTo10xRaw: from5xTo10xGivenAlive * aliveProb,
                    above10xRaw: above10xGivenAlive * aliveProb,
                    // Normalized probabilities (conditional on being alive)
                    brokeNorm: brokeGivenAlive,
                    below1xNorm: below1xGivenAlive,
                    from1xTo2xNorm: from1xTo2xGivenAlive,
                    from2xTo5xNorm: from2xTo5xGivenAlive,
                    from5xTo10xNorm: from5xTo10xGivenAlive,
                    above10xNorm: above10xGivenAlive,
                    mortality: cumulativeDeathProb  // Cumulative probability of being dead by this age
                });
            }

            // Calculate success rate (not broke at end, conditional on being alive)
            const finalYear = percentiles[percentiles.length - 1];
            
            // Debug: Check if we have valid data
            if (!finalYear || finalYear.p50 === undefined) {
                console.error('Final year data is invalid:', finalYear);
                document.getElementById('successRate').textContent = 'Error';
                document.getElementById('withdrawalRate').textContent = 'Error';
                document.getElementById('medianBalance').textContent = 'Error';
                return;
            }
            
            const brokeAtEnd = finalYear.brokeNorm;
            const successRate = ((1 - brokeAtEnd) * 100).toFixed(1);
            const withdrawalRate = ((spending / savings) * 100).toFixed(2);
            
            // Display median balance
            const medianBalance = finalYear.p50;

            // Update stats
            document.getElementById('successRate').textContent = successRate + '%';
            document.getElementById('withdrawalRate').textContent = withdrawalRate + '%';
            document.getElementById('medianBalance').textContent = formatNumber(medianBalance);

            // Render chart
            renderChart(percentiles, savings);
        }

        // Render Plotly chart
        let currentChartData = null; // Store data for re-rendering
        let currentInitialSavings = null;

        function renderChart(data, initialSavings) {
            // Store data for toggle function
            currentChartData = data;
            currentInitialSavings = initialSavings;
            
            const showMortality = document.getElementById('showMortality').checked;
            const ages = data.map(d => d.age);

            // Choose which probabilities to use based on toggle
            let brokeProb, below1xProb, from1xTo2xProb, from2xTo5xProb, from5xTo10xProb, above10xProb, deathProb;
            
            if (showMortality) {
                // Use raw probabilities (include mortality impact, financial + death = 100%)
                brokeProb = data.map(d => d.brokeRaw * 100);
                below1xProb = data.map(d => d.below1xRaw * 100);
                from1xTo2xProb = data.map(d => d.from1xTo2xRaw * 100);
                from2xTo5xProb = data.map(d => d.from2xTo5xRaw * 100);
                from5xTo10xProb = data.map(d => d.from5xTo10xRaw * 100);
                above10xProb = data.map(d => d.above10xRaw * 100);
                deathProb = data.map(d => d.mortality * 100);
            } else {
                // Use normalized probabilities (conditional on being alive, financial = 100%)
                brokeProb = data.map(d => d.brokeNorm * 100);
                below1xProb = data.map(d => d.below1xNorm * 100);
                from1xTo2xProb = data.map(d => d.from1xTo2xNorm * 100);
                from2xTo5xProb = data.map(d => d.from2xTo5xNorm * 100);
                from5xTo10xProb = data.map(d => d.from5xTo10xNorm * 100);
                above10xProb = data.map(d => d.above10xNorm * 100);
                deathProb = null; // Don't show death layer
            }
            
            const traces = [];
            
            // Bottom layer: Broke (red)
            traces.push({
                x: ages,
                y: brokeProb,
                type: 'scatter',
                mode: 'none',
                name: 'Broke',
                fillcolor: 'rgba(214, 48, 49, 0.8)',
                fill: 'tozeroy',
                hovertemplate: 'Age %{x}<br>Broke: %{y:.1f}%<extra></extra>',
                stackgroup: 'one'
            });
            
            // Below initial (orange)
            traces.push({
                x: ages,
                y: below1xProb,
                type: 'scatter',
                mode: 'none',
                name: 'Below Initial',
                fillcolor: 'rgba(253, 203, 110, 0.7)',
                fill: 'tonexty',
                hovertemplate: 'Age %{x}<br>Below Initial: %{y:.1f}%<extra></extra>',
                stackgroup: 'one'
            });
            
            // 1-2x initial (light yellow/green)
            traces.push({
                x: ages,
                y: from1xTo2xProb,
                type: 'scatter',
                mode: 'none',
                name: '1-2x Initial',
                fillcolor: 'rgba(255, 234, 167, 0.7)',
                fill: 'tonexty',
                hovertemplate: 'Age %{x}<br>1-2x Initial: %{y:.1f}%<extra></extra>',
                stackgroup: 'one'
            });
            
            // 2-5x initial (light green)
            traces.push({
                x: ages,
                y: from2xTo5xProb,
                type: 'scatter',
                mode: 'none',
                name: '2-5x Initial',
                fillcolor: 'rgba(163, 228, 215, 0.7)',
                fill: 'tonexty',
                hovertemplate: 'Age %{x}<br>2-5x Initial: %{y:.1f}%<extra></extra>',
                stackgroup: 'one'
            });
            
            // 5-10x initial (medium green)
            traces.push({
                x: ages,
                y: from5xTo10xProb,
                type: 'scatter',
                mode: 'none',
                name: '5-10x Initial',
                fillcolor: 'rgba(0, 184, 148, 0.7)',
                fill: 'tonexty',
                hovertemplate: 'Age %{x}<br>5-10x Initial: %{y:.1f}%<extra></extra>',
                stackgroup: 'one'
            });
            
            // 10x+ initial (dark green)
            traces.push({
                x: ages,
                y: above10xProb,
                type: 'scatter',
                mode: 'none',
                name: '10x+ Initial',
                fillcolor: 'rgba(0, 148, 117, 0.9)',
                fill: 'tonexty',
                hovertemplate: 'Age %{x}<br>10x+ Initial: %{y:.1f}%<extra></extra>',
                stackgroup: 'one'
            });
            
            // Death layer (only if showing mortality)
            if (showMortality && deathProb) {
                traces.push({
                    x: ages,
                    y: deathProb,
                    type: 'scatter',
                    mode: 'none',
                    name: 'Death',
                    fillcolor: 'rgba(108, 117, 125, 0.6)',
                    fill: 'tonexty',
                    hovertemplate: 'Age %{x}<br>Death: %{y:.1f}%<extra></extra>',
                    stackgroup: 'one'
                });
            }

            const layout = {
                title: '',
                xaxis: {
                    title: 'Age',
                    gridcolor: '#e9ecef',
                    showgrid: true
                },
                yaxis: {
                    title: 'Probability (%)',
                    range: [0, 100],
                    gridcolor: '#e9ecef',
                    showgrid: true
                },
                hovermode: 'x unified',
                showlegend: true,
                legend: {
                    x: 0.02,
                    y: 0.98,
                    bgcolor: 'rgba(255,255,255,0.95)',
                    bordercolor: '#dee2e6',
                    borderwidth: 1
                },
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff',
                margin: { t: 20, b: 60, l: 70, r: 20 },
                font: {
                    family: 'DM Sans, sans-serif',
                    size: 12
                }
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['lasso2d', 'select2d']
            };

            Plotly.newPlot('chart', traces, layout, config);
        }

        // Toggle mortality display
        function toggleMortality() {
            if (currentChartData) {
                renderChart(currentChartData, currentInitialSavings);
            }
        }

        // Reset form
        function reset() {
            document.getElementById('currentAge').value = 40;
            document.getElementById('retirementAge').value = 50;
            document.getElementById('lifeExpectancy').value = 40;
            document.getElementById('savings').value = 1000000;
            document.getElementById('spending').value = 40000;
            document.getElementById('withdrawalRateInput').value = 4.0;
            document.getElementById('expectedReturn').value = 5.0;
            document.getElementById('stocks').value = 60;
            document.getElementById('bonds').value = 40;
            document.getElementById('cash').value = 0;
            document.getElementById('taxRate').value = 15;
            document.getElementById('fees').value = 0.3;
            document.getElementById('flexibility').value = 20;
            document.getElementById('threshold').value = 80;
            incomeStreams = [];
            expenseStreams = [];
            renderStreams();
            calculate();
        }

        // Initialize on load
        window.addEventListener('load', () => {
            calculate();
        });
    </script>
</body>
</html>
